WITH PS_With_CountIndex AS (
    SELECT *,
           DENSE_RANK() OVER (PARTITION BY MACHINE ORDER BY DAY_INDEX) AS COUNT_INDEX
    FROM SGP.DBO.PRODUCTION_SCHEDULE
)
SELECT
    PS.MACHINE,
    PS.[OPTION],
    COUNT(DISTINCT PS.ID) AS ORDER_COUNT,
    COUNT(DISTINCT PS.PO_NUMBER) AS PO_COUNT,
    SUM((PS.MACHINE_MAX_WIDTH - PS.MACHINE_WIDTH) * PS.ROLL_QUANTITY * PS.UNIT_WEIGHT) / 
    SUM(PS.MACHINE_WIDTH * PS.ROLL_QUANTITY * PS.UNIT_WEIGHT) AS WASTAGE_PERCENTAGE,
    
    SUM(CASE WHEN PS.CUSTOMER_NAME LIKE 'DPT%' THEN 1 ELSE 0 END) AS BACKUP_ORDER_COUNT,
    
    SUM(CASE WHEN PS.CUSTOMER_NAME LIKE 'DPT%' THEN 1.000 ELSE 0 END * PS.ROLL_QUANTITY) / 
    SUM(PS.ROLL_QUANTITY) AS BACKUP_ORDER_PERCENTAGE,
    
    SUM(CASE WHEN PS.CUSTOMER_NAME LIKE 'DPT%' THEN 
             PS.ROLL_QUANTITY * PS.WIDTH/100.00 * PS.UNIT_WEIGHT ELSE 0 END) AS BACKUP_ORDER_QUANTITY,
    
    MIN(PS.ROLL_QUANTITY) AS MIN_ORDER_ROLL,
    MAX(PS.ROLL_QUANTITY) AS MAX_ORDER_ROLL,
    AVG(DIFF_CUST.NonHomogeneousDayCount) AS MIX_CUSTOMER_COUNT,
    AVG(DIFF_PO.NonHomogeneousDayCount) AS MIX_PO_COUNT,
    
    SUM(CASE WHEN PS.CUSTOMER_NAME NOT LIKE 'DPT%' THEN PS.ROLL_QUANTITY ELSE 0 END) * 1.000 / 
    AVG(TOTAL_DR_QUANTITY.QUANTITY) AS DELIVERY_PERCENTAGE,
    
    SUM(CASE WHEN PS.CUSTOMER_NAME NOT LIKE 'DPT%' AND 
                    PS.CUSTOMER_NAME IN ('SET', 'DNH', 'PPT', 'MIT', 'LTP', 'LAB', 'DAT') 
             THEN PS.ROLL_QUANTITY ELSE 0 END) * 1.000 / 
    AVG(TOTAL_PRIOR_QUANTITY.QUANTITY) AS PRIORITY_CUSTOMER_DELIVERY_PERCENTAGE,
    
    PS.COUNT_INDEX  -- Added Count_Index

FROM PS_With_CountIndex PS
OUTER APPLY
(
    SELECT COUNT(DISTINCT DAY_INDEX) AS NonHomogeneousDayCount
    FROM (
        SELECT MACHINE, [OPTION], DAY_INDEX
        FROM SGP.DBO.PRODUCTION_SCHEDULE
        WHERE MACHINE = PS.MACHINE AND [OPTION] = PS.[OPTION]
        GROUP BY MACHINE, [OPTION], DAY_INDEX
        HAVING COUNT(DISTINCT CUSTOMER_NAME) > 1
    ) AS NonHomogeneousDays
    GROUP BY MACHINE
) DIFF_CUST
OUTER APPLY
(
    SELECT COUNT(DISTINCT DAY_INDEX) AS NonHomogeneousDayCount
    FROM (
        SELECT MACHINE, [OPTION], DAY_INDEX
        FROM SGP.DBO.PRODUCTION_SCHEDULE
        WHERE MACHINE = PS.MACHINE AND [OPTION] = PS.[OPTION]
        GROUP BY MACHINE, [OPTION], DAY_INDEX
        HAVING COUNT(DISTINCT PO_NUMBER) > 1
    ) AS NonHomogeneousDays
    GROUP BY MACHINE
) DIFF_PO
OUTER APPLY
(
    SELECT SUM(PO_ROLL) AS QUANTITY 
    FROM SGP.DBO.DELIVERY_REQUEST DR
    WHERE
    ((DR.PRODUCT LIKE '%TEST%' AND PS.ITEM_NAME LIKE '%TEST%')
    OR (DR.PRODUCT LIKE '%MEDIUM%' AND PS.ITEM_NAME LIKE '%MEDIUM%'))
    AND DR.CUSTOMER NOT LIKE 'DPT%'
) TOTAL_DR_QUANTITY
OUTER APPLY
(
    SELECT SUM(PO_ROLL) AS QUANTITY 
    FROM SGP.DBO.DELIVERY_REQUEST DR
    WHERE
    ((DR.PRODUCT LIKE '%TEST%' AND PS.ITEM_NAME LIKE '%TEST%')
    OR (DR.PRODUCT LIKE '%MEDIUM%' AND PS.ITEM_NAME LIKE '%MEDIUM%'))
    AND DR.CUSTOMER NOT LIKE 'DPT%' 
    AND DR.CUSTOMER IN ('SET', 'DNH', 'PPT', 'MIT', 'LTP', 'LAB', 'DAT') 
) TOTAL_PRIOR_QUANTITY
GROUP BY
    PS.MACHINE,
    PS.[OPTION],
    PS.COUNT_INDEX
ORDER BY PS.[OPTION] ASC;
